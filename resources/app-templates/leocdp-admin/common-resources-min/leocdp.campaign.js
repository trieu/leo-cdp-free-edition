'use strict';var campaignView=function(d){location.hash="calljs-leoCdpRouter('Campaign_Info','"+d+"')"},campaignEditor=function(d){location.hash="calljs-leoCdpRouter('Campaign_Editor','"+d+"')"},campaignRunImmediately=function(d){console.log("campaignRunImmediately "+d)},campaignScheduler=function(d){console.log("campaignScheduler "+d)},campaignListRefresh=function(){location.hash="#calljs-leoCdpRouter('Automated_Campaigns','_refresh_"+(new Date).getTime()+"')"};
function loadCampaignList(){var d=getUserSession();d&&$("#campaign-list").DataTable({processing:!1,serverSide:!1,serverMethod:"POST",ajax:{url:baseLeoAdminUrl+"/cdp/campaigns/filter",contentType:"application/json",beforeSend:function(b){b.setRequestHeader("leouss",d)},data:function(b){console.log(b);return JSON.stringify(b)}},columnDefs:[{render:function(b,a,c){b=textTruncate(b,60);return'\x3ca title\x3d"'+c.name+'" href\x3d"javascript:campaignView(\''+(c.id+"')\" \x3e")+b+"\x3c/a\x3e"},targets:0},
{render:function(b,a,c){a="USER_DEFINED";1===b?a="BRAND_AWARENESS":2===b?a="LEAD_GENERATION":3===b?a="CONVERSION_OPTIMIZATION":4===b?a="RETENTION_OPTIMIZATION":5===b?a="CROSS_SELLING":6===b?a="UPSELLING":7===b&&(a="REFERRAL_PROGRAM");return'\x3cdiv class\x3d"datatable_text text-center"\x3e'+a+"\x3c/div\x3e"},targets:1},{render:function(b,a,c){a="DRAFT";1===b?a="PLANNED":2===b?a="IN_PROGRESS":3===b?a="COMPLETED":4===b?a="CANCELED":-1===b&&(a="DELETED");return'\x3cdiv class\x3d"datatable_text text-center"\x3e'+
a+"\x3c/div\x3e"},targets:2},{render:function(b,a,c){return'\x3cdiv class\x3d"datatable_text text-center"\x3e'+b+"\x3c/div\x3e"},targets:3},{render:function(b,a,c){return moment.utc(new Date(b)).local().format("YYYY-MM-DD HH:mm:ss")},targets:4},{render:function(b,a,c){return b?moment.utc(new Date(b)).local().format("YYYY-MM-DD HH:mm:ss"):"-"},targets:5},{render:function(b,a,c){a="#calljs-leoCdpRouter('User_Login_Report','"+b+"')";return $("\x3ca/\x3e").attr("href",a).html(b)[0].outerHTML},targets:6},
{render:function(b,a,c){b="javascript:campaignRunImmediately('"+c.id+"')";a="javascript:campaignScheduler('"+c.id+"')";c='\x3cdiv style\x3d"width:81px"\x3e \x3ca class\x3d"control" title\x3d"Campaign Details" href\x3d"javascript:campaignView(\''+(c.id+'\')" \x3e\x3ci class\x3d"fa fa-line-chart" aria-hidden\x3d"true"\x3e\x3c/i\x3e Details\x3c/a\x3e \x3cbr\x3e\x3ca class\x3d"control" title\x3d"Campaign Editor" href\x3d"javascript:campaignEditor(\'')+(c.id+'\')" \x3e\x3ci class\x3d"fa fa-pencil-square-o" aria-hidden\x3d"true"\x3e\x3c/i\x3e  Edit\x3c/a\x3e \x3cbr\x3e');
return c=c+('\x3ca class\x3d"control" title\x3d"Schedule campaign" href\x3d"'+a+'" \x3e\x3ci class\x3d"fa fa-clock-o" aria-hidden\x3d"true"\x3e\x3c/i\x3e Schedule\x3c/a\x3e  \x3cbr\x3e\x3ca class\x3d"control" title\x3d"Run campaign immediately" href\x3d"')+(b+'" \x3e\x3ci class\x3d"fa fa-play" aria-hidden\x3d"true"\x3e\x3c/i\x3e Run \x3c/a\x3e \x3c/div\x3e')},targets:7}],columns:[{data:"name"},{data:"type"},{data:"status"},{data:"targetedSegmentNames"},{data:"updatedAt"},{data:"lastRunAt"},{data:"ownerUsername"},
{data:"automatedFlow"}]})}
function initCampaignMetadata(d){var b=d.name;document.title="Campaign Editor: "+b;$("#campaign_name_header").text("Campaign: "+b);$("#campaign_description").val(d.description);$("#campaign_name").val(b).keyup(function(){d.name=$(this).val().trim();$("#campaign_name_header").text("Campaign: "+d.name)});null!=d.automatedFlowJson&&(b=Handlebars.compile(d.automatedFlowJson)({segment_name:"test",condition_name:"Today is the birthday of customer",condition_expression:'context.isCurrentDateEqualProfileBirthday("@{currentDate}")',campaign_action_type:"email"}),
b=JSON.parse(b),renderCampaignAutomatedFlow(b));getAllSegmentRefs(function(a){var c=$("#campaign_targetedSegmentIds").empty();a.forEach(function(f){c.append($("\x3coption /\x3e").attr("value",f.id).text(f.name))});$("#campaign_targetedSegmentIds").chosen({width:"100%",no_results_text:"No data available!"}).trigger("chosen:updated")});$("#campaign_condition").chosen({width:"100%",no_results_text:"No data available!"}).change(function(){var a=$(this).val();console.log(a);"getEventAtUrl"===a?$("#eventMetricWithUrlForCondition").show():
$("#eventMetricWithUrlForCondition").hide()}).trigger("chosen:updated");$("#campaign_action_type").chosen({width:"100%",no_results_text:"No data available!"}).change(function(){var a=$(this).val();console.log(a);$("#frequencyCappingType").text(a.toUpperCase())}).trigger("chosen:updated");$("#frequencyCappingType").text($("#campaign_action_type").find(":selected").val());$("#frequencyCappingTimeUnit").chosen({width:"100%",no_results_text:"No data available!"}).change(function(){var a=$(this).val();
console.log(a)}).trigger("chosen:updated");loadEventMetricsForCampaignEventTrigger([])}var automatedFlowJsonData={};
function loadCampaignEditor(d){var b=$("#campaign_editor_loader"),a=$("#campaign_editor_div");LeoAdminApiUtil.callPostAdminApi(baseLeoAdminUrl+"/cdp/campaign/get",{id:d},function(c){b.hide();a.show();0===c.httpCode&&""===c.errorMessage?(c.canEditData?$("button.data-control-edit").click(function(){location.hash="calljs-leoCdpRouter('Campaign_Editor','"+d+"')"}):$("button.data-control-edit").attr("disabled","disabled"),c.data&&initCampaignMetadata(c.data)):LeoAdminApiUtil.logErrorPayload(c)})}
function loadEventMetricsForCampaignEventTrigger(d){LeoAdminApiUtil.getSecuredData("/cdp/funnel/event-metrics",{},function(b){var a="";b.data.forEach(function(c){a=d.includes(c.eventName)?a+('\x3coption selected value\x3d"'+c.id+'"\x3e'+c.eventLabel+"\x3c/option\x3e"):a+('\x3coption value\x3d"'+c.id+'"\x3e'+c.eventLabel+"\x3c/option\x3e")});$("#eventForCampaignCondition").html(a).chosen({width:"100%",no_results_text:"Oops, nothing found!"}).change(function(){var c=$(this).val();console.log(c)}).trigger("chosen:updated")})}
function renderCampaignAutomatedFlow(d){mermaid.initialize({startOnLoad:!1,securityLevel:"loose",useMaxWidth:!0});var b=jsonToMermaid(d);console.log("jsonToMermaid \n ",b);const a=document.getElementById("campaignAutomatedFlow");(function(){mermaid.render("id",b).then(({svg:f,bindFunctions:e})=>{a.innerHTML=f;e&&e(a)});automatedFlowJsonData=mermaidToJSON(b);const c=JSON.stringify(automatedFlowJsonData,null,2);console.log("mermaidToJSON:",c);console.log("mermaidToJSON \x3d\x3d\x3d automatedFlowJsonData:",
c===automatedFlowJsonData)})()}function automatedFlowNodeClick(d){console.log(d);notifySuccessMessage(d)}
function mermaidToJSON(d){d=d.split("\n").map(a=>a.trim()).filter(a=>a);const b=automatedFlowJsonData;b.rules=[];d.forEach(a=>{a=a.trim();try{if(a.startsWith("flowchart"))b.type="flowchart";else if(a.includes("--\x3e")){var [c,f]=a.split("--\x3e"),[,e,g]=f.includes("|")?f.split("|"):[null,f];e=e?e.trim():null;g=g?g.trim().replace(/ \[\[|\]\] /g,""):e;b.rules.push({start:c.trim(),conditionResult:e&&e!=g?e:null,end:g})}else if(a.includes("[")){const h=a.split("[")[0].trim(),l=a.match(/\[(.*?)\]/)?.[1].trim();
var k=b.nodes[h];"object"===typeof k?(k.id=h,k.label=l):b.nodes[h]={id:h,label:l}}else console.log("mermaidToJSON, skip line: ",a)}catch(h){console.log("error",a)}});return b}
function jsonToMermaid(d){let b=`${d.type} ${"LR"}\n`;Object.values(d.nodes).forEach(a=>{b+=`${a.id}[${a.label}]\n`;b+=`click ${a.id} href "javascript:automatedFlowNodeClick('${a.id}')"\n`});d.rules.forEach(a=>{a.conditionResult?(a.conditionResult=a.conditionResult,b+=`${a.start} -->|${a.conditionResult}| ${a.end}\n`):b+=`${a.start} --> ${a.end}\n`});return b};