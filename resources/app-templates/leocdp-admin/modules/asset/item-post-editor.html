<div class="container-fluid" id="post_editor_form">

    <!-- MAIN BODY here -->
     <div class="row">
        <div class="col-lg-10">
	         <h5 class="page-header" id="page_breadcrumb" > </h5>
        </div>
       	<div class="col-lg-2 text-right">
            
	        <button type="button" class="btn btn-danger data-control-delete" id="btn_delete_page" style="display: none;" >
	            <i class="fa fa-trash" aria-hidden="true"></i> Delete
	        </button>
	        
	        <button type="button" class="btn btn-primary data-control-edit" id="btn_edit_page" style="display: none;"  > 
	       		<i class="fa fa-fw fa-pencil-square-o"></i> Edit 
	       	</button>
           
        </div>
    </div>
    
    <!-- MAIN BODY here -->
    <div class="row">
        <div class="col-lg-9">

            <fieldset>

                <div class="form-group">
                    <label>Slug (SEO-friendly URL)</label>
                    <div id="slug_div" >
                        <input type="text" name="slug" class="form-control">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Title</label>
                    <input id="asset_item_title" type="text" class="form-control" placeholder="Enter title" name="title" autocomplete="off">
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <div id="description_div" style="display: block;">
                        <textarea class="form-control" rows="2" placeholder="Enter description" name="description"></textarea>
                    </div>
                    <hr>
                </div>
                
                <div id="content_link_url_holder" class="alert alert-info" role="alert" >
					 <i class="fa fa-qrcode" aria-hidden="true" style="font-size: 1.1em" ></i>  <b>Short Link URL</b> 
					 <a id="content_link_url" class="small-text" href="javascript:" target="_blank" ></a> <br>
				</div>	
				<div class="thumbnail">
				 	 <img id="content_link_qrcode_url" style="max-height: 200px" />
				</div>

 				<div>
                	<label for="imageUploader"> Headline Image Uploader </label>
	                <input id="imageUploader" type="file" class="filepond" name="image" multiple data-max-file-size="20MB"
	                    data-max-files="20" />
	                <input id="headlineImageUrl" type="url" class="form-control" placeholder="Enter Headline Image URL" name="headlineImageUrl" autocomplete="off">
                    
            	</div>
                <div id="post-headline-images">
                	<!-- Headline Images -->
                </div>
                <hr>

                <div class="panel panel-default">
                    <div class="panel-heading"> <label>YouTube Video URL</label> </div>
                    <div class="panel-body">
                        <input id="headline_video" type="text" name="headlineVideoUrl" placeholder="Enter YouTube Video URL" class="form-control">
                        <div id="headline_video_view" class="row display-flex" style="padding: 0 50px;width: 520px;margin: auto" >                           
                        </div>
                    </div>
                </div>
                <hr>
				
                <div class="form-group" id="content_div_wrapper">
                    <div>
		                <label for="documentUploader"> Editor File Uploader </label>
		                <input id="documentUploader" type="file" class="filepond" name="document" multiple data-max-file-size="50MB" data-max-files="20" />
		            </div>
		            <label>Content</label>
		            <button type="button" class="btn btn-info" data-visibilty="hidden" onclick="toggleRawHtmlEditor(this)" style="margin: 9px 9px;"> 
		        		<i class="fa fa-fw fa-code"></i> Show HTML Editor 
		        	</button>
                    <div id="content_div">
                    </div>                   
                    <div id="raw_media_container" style="width: 100%;" >
                        <textarea id="raw_media_html"></textarea>
                    </div>                   
                    <div id="mediaInfoPreview" ></div>
                </div>

            </fieldset>

        </div>
        <div class="col-lg-3">
            <div id="error-on-save" class="alert alert-danger" style="display: none;"></div>
            <div class="action-div row-centered ">
                <button type="button" class="btn btn-info" onclick="history.back()">
                	<i class="fa fa-arrow-circle-left" aria-hidden="true"></i>
                	Back
                </button>
                <button type="button" class="btn btn-danger" onclick="LeoCdpAdmin.navFunctions.deleteItemAsset(itemData)">
                	<i class="fa fa-trash" aria-hidden="true"></i> Delete
                </button>
                <button type="button" class="btn btn-success data-control-edit" onclick="postEditorSave()"  > 
	        		<i class="fa fa-fw fa-check"></i> Save 
	        	</button>  
            </div>
            <hr>
            <div class="action-div"  >
                <label>Content Class Type</label>
                <select id="contentClass" name="contentClass" data-placeholder="Choose a content class" class="select">
                    <option value="standard" selected>Creative Content</option>
                    <option value="youtube_video">YouTube Embedded Video</option>
                    <option value="blogpost" >BlogPost</option>                    
                    <option value="news">News</option>
                    <option value="company_info">Company Information</option>
                    <option value="price_list">Price List</option>
                    <option value="case_study"> Case Study</option>
                    <option value="customer_service"> Customer Service</option>
                    <option value="document">Document</option>
                </select>
            </div>
            <hr style="display: none" >
            <div class="action-div" style="display: none">
                <label>Content Display Type </label>
                <select id="postType" name="postType" data-placeholder="Choose a post type" class="select">
                 	<option value="9" selected="selected"> VIDEO_AND_BLOG </option>
                 	
                    <option value="1"> TEXT</option>
                    <option value="3"> OFFICE_DOCUMENT</option>
                    <option value="4"> VIDEO</option>
                   
                    <option value="8"> IMAGE_SLIDESHOW</option>
                </select>
            </div>
            <hr style="display: none">
            <div class="action-div">
                <label>Access Privacy</label>
                <div class="radio">
                    <label><input type="radio" name="privacyStatus" value="0">Public for everyone</label>
                </div>
                <div class="radio">
                    <label><input type="radio" name="privacyStatus" value="1">Protected (for logged users)</label>
                </div>
                <div class="radio">
                    <label><input type="radio" name="privacyStatus" value="-1">Private</label>
                </div>
            </div>
            <hr>
            <div class="action-div">
                <label>Content Keywords</label>
                <input id="postKeywords" name="keywords" type="text" class="tags" value="" />
            </div>
            
        </div>
    </div>
</div>


<script>
    var itemId = "";
    var groupId = "";
    var categoryId = "";
    
    var itemData = false;
    var trixElement = false;
    var postType = 9;

    //templates
    var editorViewTpl = '<input id="mediaInfo" value="" type="hidden" name="mediaInfo"><trix-editor input="mediaInfo" class="trix-content" autofocus></trix-editor>';
    var documentUrlViewTpl = '<input id="mediaInfo" type="text" name="mediaInfo" class="form-control" >';

    //raw HTML code editor
    var rawHtmlEditor = CodeMirror.fromTextArea(document.getElementById("raw_media_html"), {        
        mode: "htmlmixed",           
        lineNumbers: true ,
        smartIndent: true ,
        lineWrapping : true                                    
    });
    rawHtmlEditor.setSize( $('#raw_media_container').width() - 80, 1);

    function postTypeSelectionCallback(type) {
        postType = type;
        checkPostTypeAndSetupMediaEditor(postType, '');
    }
    
    function initPostEditor(params){
    	itemData = false;
    	LeoCdpAdmin.loadView('/view/common-widgets/headline-images.html?admin=1', '#post-headline-images', function () {
            $('#post-headline-images div.thumbnail p').editable({ type: 'text', title: 'Enter Image Label Value' },true);
            loadDataPostEditor(params)
        }, true);
    }

    function loadDataPostEditor(params) {
        if (params) {
            itemId = params.itemId;
            groupId = params.groupId;
            categoryId = params.categoryId;
            console.log('=====> loadDataPostEditor itemId ' + itemId);

            if (itemId === '') {
                // off select post type  $('#postTypeSelectionDialog').modal({ focus: true })
                postTypeSelectionCallback(1);//default post type is text
                setupImageInputForContent('#headlineImageUrl', "")
            }
            var urlStr = baseLeoAdminUrl + '/cdp/asset-item/get';
            LeoAdminApiUtil.callPostAdminApi(urlStr, params, function (json) {
                if (json.httpCode === 0 && json.errorMessage === '') {
                    itemData = json.data;
                    document.title = itemData.title ? 'Post Editor - ' + itemData.title : 'New Content Post';
                    
                 	// breadcrumb link update
        	        updateBreadcrumbInAssetPost(itemData.assetCategories, itemData.assetGroups, itemData.title );

                    var form = $('#post_editor_form');
                    for (var k in itemData) {
                        var value = itemData[k];
                        var fieldType = typeof value;

                        if (fieldType === 'object') {
                            if (k === 'keywords') {
                                form.find("input[name='keywords']").val(value.join(","));
                            } else if (k === 'headlineImages') {
                                loadHeadLineImageObjectToView(value, true);
                            } 
                        } 
                        else if (fieldType === 'number' || fieldType === 'string') {
                            if (k === 'mediaInfo') {
                                postType = itemData.type;
                                checkPostTypeAndSetupMediaEditor(postType, value);
                                loadMediaInfoView(value, postType, true);
                            } 
                            else if (k === 'privacyStatus') {
                                form.find("input[name='privacyStatus'][value='" + value + "']").attr('checked', 'checked');
                            } 
                            else if (k === 'description') {
                                form.find("textarea[name='description']").val(value);
                            } 
                            else if (k === 'slug') {
                                form.find("input[name='slug']").val(value);
                                $("#content_link_url").attr("href",itemData.shortLinkUrl).text(itemData.shortLinkUrl);
                                $("#content_link_qrcode_url").attr("src",itemData.qrCodeUrl);
                            } 
                            else if (k === 'contentClass') {
                                var dom = $('#contentClass');
                                dom.find("option:selected").removeAttr("selected");
                                dom.find('option[value="' + value + '"]').attr('selected', 'selected');
                                contentClassViewRender(value);
                            } 
                            else if(k === 'type'){                                
                                var dom = $('#postType');
                                dom.find("option:selected").removeAttr("selected");
                                dom.find('option[value="' + value + '"]').attr('selected', 'selected');
                            } 
                            else if(k === 'headlineVideoUrl') {
                                var value = value.trim()
                                if(value.indexOf('http') === 0){   
                                    var placeHolderId = 'hvph_' + itemId;                                 
                                    var html = '<div id="'+placeHolderId+'" class="videoholder" data-video-source="'+value+'"></div>';
                                    $('#headline_video').val(value);
                                    $('#headline_video_view').html(html);
                                    MediaPlayerOne.create(false, placeHolderId, value, '', [], 1, []);
                                }                               
                            }     
                            else if(k === "headlineImageUrl") {
                            	var imgUrl = (value.indexOf('/public/') === 0) ? baseStaticUrl + value.replace('/public/','/') : value;
                            	setupImageInputForContent('#headlineImageUrl', imgUrl)
                            }
                            else {
                                form.find("input[name='" + k + "']").val(value);
                            }
                        }
                        console.log(k + " : " + value + " fieldType :" + fieldType)
                    }
                    loadWidgetsOfPostForm();
                    
                    //focus the title
                    $('#asset_item_title').focus();
                } else {
                    LeoAdminApiUtil.logErrorPayload(json);
                }
            });
        }
    }

    function saveDataPostEditor(callback) {
        if (itemData) {
            itemData.itemId = itemId;
            itemData.groupId = groupId;
            itemData.categoryId = categoryId;
            itemData.type = postType;

            //get DOM view and set into itemData
            var form = $('#post_editor_form');
            itemData.title = form.find('input[name="title"]').val().trim();
            itemData.slug = form.find('input[name="slug"]').val();
            itemData.privacyStatus = parseInt(form.find('input[name="privacyStatus"]:checked').val());
            itemData.keywords = form.find('input[name="keywords"]').val().split(',');            
            itemData.description = form.find('textarea[name="description"]').val();
            itemData.headlineImages = getHeadLinesImagsObject();
            itemData.headlineImageUrl = $('#headlineImageUrl').val()
            itemData.headlineVideoUrl = form.find('#headline_video').val();
            itemData.contentClass = form.find('select[name="contentClass"]').val();
            itemData.type = parseInt(form.find('select[name="postType"]').val());
            itemData.customData = {};
            if(itemData.contentClass === 'project'){
                //in project, auto build data from customData
                //var obj = {};                
                //var finalMediaHtml = getCompiledTemplate('#customData4mediaInfo_tpl')({'customData':obj}).trim();
                //itemData.mediaInfo = finalMediaHtml;
            }
            itemData.mediaInfoUnits = getMediaInfoUnits();

            //normalize html data
            if(itemData.type === 1){
                var content = form.find('input[name="mediaInfo"]').val();                             
                itemData.mediaInfo = normalizeMediaHtml(content).trim();
            } else {
                itemData.mediaInfo = form.find('input[name="mediaInfo"]').val().trim();
            } 
            
            if(itemData.title === "" || itemData.mediaInfo === "") {
            	iziToast.error({
            	    title: 'Error',
            	    message: 'The title and content can not be empty !'
            	});
            } else {
            	 // show loader
                $('#ajaxLoaderDialog').modal({
            		backdrop: 'static',
            		keyboard: false
        		});
                
                //done set data model, POST to API
                var urlStr = baseLeoAdminUrl + '/cdp/asset-item/save';
                LeoAdminApiUtil.callPostAdminApi(urlStr, itemData, function (json) {
                    if (json.httpCode === 0 && json.errorMessage === '') {
                        if (typeof callback === 'function') {
                            if(json.data === ''){
                                $('#error-on-save').html('Data is not valid !').show().delay(6000).fadeOut('slow');
                            } else {
                                callback(json.data);
                            }                        
                        }
                    } else {
                        $('#error-on-save').html(json.errorMessage).show().delay(6000).fadeOut('slow');
                        LeoAdminApiUtil.logErrorPayload(json);
                    }
                });
            }
        }
    }

    function postEditorSave() {
        var onSaveOk = function (itemId) {   
            $('#ajaxLoaderDialog').modal('hide');   
            location.hash =  "#calljs-leoCdpRouter('Asset_Group_Details','" + groupId + "')";
        }
        saveDataPostEditor(onSaveOk);
    }

    /*
    var htmlEditor = CodeMirror.fromTextArea(document.getElementById("code"), {
        lineNumbers: true,
        mode: 'htmlmixed',
        // theme: 'default',
    });
    */

    function loadWidgetsOfPostForm() {

        //keyword input widget with highlights
        $('#postKeywords').tagsInput({
            width: 'auto',
            'defaultText': 'add a keyword',
            onChange: function (elem, elem_tags) {
                var productTags = ['Coated', 'Lysaght', 'Retail'];
                $('.tag', elem_tags).each(function () {
                    if ($(this).text().search(new RegExp('\\b(' + productTags.join('|') + ')\\b')) >=0){
                        $(this).css('background-color', 'yellow');
                    }                       
                });
            }
        });

        //content data class widget
        $('#contentClass').chosen({
            width: "100%",
            no_results_text: "Oops, nothing found!"
        }).trigger("chosen:updated").change(function () {
            contentClassViewRender($(this).val());
        });

        //content display type widget
        $('#postType').chosen({
            width: "100%",
            no_results_text: "Oops, nothing found!"
        }).trigger("chosen:updated").change(function () {     
            //TODO
        });

        //document or image uploader
        setupUploaderWidget('post', itemId, '#documentUploader', function (rs) {
            var fileUrl = rs.data.fileUrls[0];
            console.log('fileUrl ' + fileUrl);
            renderPostMediaInfo(fileUrl);
            if (postType !== 1 && postType !== 2) {
                // the media is not text, store as URL
                $('#mediaInfo').val(fileUrl);
            }
        });

        //headline image uploader
        setupUploaderWidget('post', itemId, '#imageUploader', function (rs) {
            var imgSrc = rs.data.fileUrls[0];
            var obj = {};
            obj[imgSrc] = '';
            loadHeadLineImageObjectToView(obj, false, true);
        });

        $('#headline_video').on('change', function(){
            var $this = $(this);
            var currentVal = $this.val();
            
            //$this.val(vid);
            //var html = "<iframe width='100%' height='320' src='https://www.youtube-nocookie.com/embed/"+vid+"?rel=0&controls=1&showinfo=0' frameborder='0' allow='accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture' allowfullscreen></iframe>";
            
            //init MediaPlayer
            var placeHolderId = 'hvph_' + itemId;
            var html = '<div id="'+placeHolderId+'" class="videoholder" data-video-source="'+currentVal+'"></div>';
            $('#headline_video_view').html(html);
            MediaPlayerOne.create(false, placeHolderId, currentVal, '', [], 1, []);
            
            //init HeadLine Images
            var ytVideoId = getYouTubeVideoId(currentVal);
            if(ytVideoId && ytVideoId.length > 5) {
                var imageUrl = 'https://img.youtube.com/vi/'+ytVideoId+'/hqdefault.jpg';
                var obj = {};
                obj[imageUrl] = "";
                loadHeadLineImageObjectToView(obj, false, true);
                $('#headlineImageUrl').val(imageUrl);
            }
        });
    }


    function getMediaInfoUnits(){        
        var list = [];
        $('#mediaInfoUnit_div > div.mediaInfoUnit').each(function(){
            var headline = $(this).find('input[name="miuHeadline"]').val().trim();
            if(headline != ''){
                var val = $(this).find('input[name="miuContent"]').val();
                var content = normalizeMediaHtml(val);                
                list.push({'headline':headline,'content':content});
            }    
        });
        return list;
    }

    function contentClassViewRender(contentClass) {
        console.log('contentClassViewRender ' + contentClass)
        if (contentClass === 'product') {
            //-------------------------TODO-------------------------
            $('#content_div_wrapper').hide();
            $('#mediaInfoUnit_wrapper').show();
            
        } 
    }

    function renderPostMediaInfo(fileUrl) {
        if(fileUrl.indexOf('http')<0){
            fileUrl = window.baseLeoAdminUrl + fileUrl;
        }
        if (fileUrl.indexOf('.png') > 0 || fileUrl.indexOf('.jpg') > 0) {            
            if (trixElement) {
                trixElement.editor.insertHTML('<img style="max-width:100%;max-height:600px;" src="' + fileUrl + '" />');
                return;
            } else {
                var html = '<img src="' + fileUrl + '" style="max-width:100%;max-height:600px;" />';
                $('#mediaInfoPreview').html(html);
            }
        } else {
            loadMediaInfoView(fileUrl, postType, true);
        }
    }
   
</script>
